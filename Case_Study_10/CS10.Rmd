---
title: "Mapping The Great American Housing Crash"
author: "Erik McDonald"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:  
    keep_md: true
    toc: true
    toc_float: true
    code_folding: hide
    fig_height: 6
    fig_width: 12
    fig_align: 'center'
---

```{r, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r load_libraries, include=FALSE}
library(tidyverse)
library(buildings)
library(USAboundaries)
library(stringr)
```

```{r load_data, include=FALSE}
buildings::permits
```

## Background

It is agreed that the Great Recession initially started to take its toll around late 2007 and throughout 2008. However to those who were paying attention, the signs could be seen well ahead of the onset of the crisis. In order to better understand how housing trends led up to the crisis we will take a look at percent change in housing starts across the US and in California from 1999 to 2010.

## Data Wrangling

```{r tidy_data}
states <- us_states() %>%
  filter(state_abbr != "AK" & state_abbr != "PI" & state_abbr != "HI") %>%
  mutate(State = state_abbr)

ca_cont <- us_counties() %>%
  filter(state_abbr == "CA")


ca_perm <- permits %>%
  filter(variable == "Single Family" & StateAbbr == "CA") %>%
  mutate(name = str_sub(countyname, end = -8)) %>%
  group_by(name, year) %>%
  summarise(sum(value)) %>% 
  mutate(pct_change = (`sum(value)`/lag(`sum(value)`) - 1) * 100) %>%
  mutate(abr = "CA")



p <-  permits %>%
  filter(variable == "Single Family") %>%
  group_by(StateAbbr, year) %>%
  summarise(sum(value)) %>% 
  mutate(pct_change = (`sum(value)`/lag(`sum(value)`) - 1) * 100) %>%
  mutate(State = StateAbbr) %>%
  mutate(permits = `sum(value)`)


country_data <- inner_join(states, p, by = "State")

ca_data <- inner_join(ca_perm, ca_cont, by = "name")
```

## Data Visualization

The first visualization will examine the continental United States.
```{r plot_data}
country_data %>%
  filter(between(year, 1999,2010)) %>%
  filter(between(pct_change, -90, 100)) %>%
  ggplot() +
  geom_sf(aes(fill = pct_change)) +
  scale_fill_gradient2(low = "red", mid = "white",
                       high = "green", midpoint = 0,
                       na.value = "grey50") +
  facet_wrap(~year) +
  labs(fill = "Percent Change", title = "Trends in U.S. Housing Starts", subtitle = "(1999 - 2010)") +
  theme_bw() +
  theme(legend.position = "bottom")
```

The next graphic takes a look at housing trends in the state of California by county throughout the same time period.

```{r}
ca_data %>%
  filter(between(year, 1999,2010)) %>%
  filter(between(pct_change, -90, 100)) %>%
  ggplot() +
  geom_sf(aes(fill = pct_change)) +
  scale_fill_gradient2(low = "red", mid = "white",
                       high = "green", midpoint = 0,
                       na.value = "grey50") +
  facet_wrap(~year) +
  labs(fill = "Percent Change", title = "Trends in CA Housing Starts", subtitle = "(1999 - 2010)") +
  theme_bw() +
  theme(legend.position = "bottom")
```

